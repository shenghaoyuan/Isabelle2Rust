.PHONY: open build code run test targeted clean help

#### Configuration ####

DEFAULT_FILE    := $(CURDIR)/Rust_Setup.thy

SESSION         := Test
ROOT_FILE       := ROOT

# Tools
CARGO           ?= cargo
ISABELLE_BUILD  := isabelle build -v -e -d . $(SESSION)
ISABELLE_BUILD_SILENT := isabelle build -e -d . $(SESSION)

# Default directories (留空，交给用户/调用处传入)
# TEST_DIR     ?= tests_targeted          # where .thy tests live
# RUST_OUT     ?= tests_targeted/Rust_Out # where Rust export/ lives
# User must provide TEST_THEORY, no default


#### Targets ####


# Open the default Isabelle theory in jEdit
open:
	isabelle jedit -d . $(DEFAULT_FILE)

# Generate ROOT from ROOT.template and build the Isabelle session.
# Requires:
#   TEST_DIR       directory containing the .thy file
#   TEST_THEORY    base name of the theory (without .thy)
#
# Usage:
#   make build TEST_DIR=tests_targeted TEST_THEORY=Max_Test
build:
	@if [ -z "$(TEST_DIR)" ] || [ -z "$(TEST_THEORY)" ]; then \
	  echo "Error: missing parameters for 'build'."; \
	  echo "Usage:   make build TEST_DIR=<dir> TEST_THEORY=<thy-name>"; \
	  echo "Example: make build TEST_DIR=tests_targeted TEST_THEORY=Max_Test"; \
	  exit 1; \
	fi
	@echo "Generating $(ROOT_FILE) for theory: $(TEST_DIR)/$(TEST_THEORY).thy"
	@sed \
	  -e 's|@TEST_DIR@|$(TEST_DIR)|g' \
	  -e 's|@TEST_THEORY@|$(TEST_THEORY)|g' \
	  ROOT.template > $(ROOT_FILE)
	@echo "Building Isabelle session '$(SESSION)'..."
	@$(ISABELLE_BUILD)

# Isabelle build using existing ROOT (no template substitution).
code:
	@$(ISABELLE_BUILD)

# Run exported Rust projects for a given theory.
#
# Requires:
#   TEST_THEORY    e.g. Max_Test
#   RUST_OUT       e.g. tests_targeted/Rust_Out
#
# Usage:
#   make run TEST_THEORY=Max_Test RUST_OUT=tests_targeted/Rust_Out
run:
	@if [ -z "$(TEST_THEORY)" ] || [ -z "$(RUST_OUT)" ]; then \
	  echo "Error: missing parameters for 'run'."; \
	  echo "Usage:   make run TEST_THEORY=<thy-name> RUST_OUT=<rust-out-root>"; \
	  echo "Example: make run TEST_THEORY=Max_Test RUST_OUT=tests_targeted/Rust_Out"; \
	  exit 1; \
	fi
	@OUT_DIR="$(RUST_OUT)/$(TEST_THEORY)"; \
	if [ ! -d "$$OUT_DIR" ]; then \
	  echo "Output directory not found: $$OUT_DIR"; \
	  echo "Expected: $$OUT_DIR"; \
	  exit 1; \
	fi; \
	MANIFESTS=$$(find "$$OUT_DIR" -maxdepth 2 -type f -name Cargo.toml | sort); \
	if [ -z "$$MANIFESTS" ]; then \
	  echo "No Cargo.toml found under $$OUT_DIR"; \
	  exit 1; \
	fi; \
	for m in $$MANIFESTS; do \
	  echo "=== Running Cargo project: $$m ==="; \
	  RUSTFLAGS="-Awarnings" $(CARGO) run --manifest-path "$$m" || exit 1; \
	  echo ""; \
	done

# Convenience target: build + run in one step.
#
# Requires:
#   TEST_DIR       e.g. tests_targeted
#   TEST_THEORY    e.g. Max_Test
#
# Usage:
#   make test TEST_DIR=tests_targeted TEST_THEORY=Max_Test
test:
	@if [ -z "$(TEST_DIR)" ] || [ -z "$(TEST_THEORY)" ]; then \
	  echo "Error: missing parameters for 'test'."; \
	  echo "Usage:   make test TEST_DIR=<dir> TEST_THEORY=<thy-name>"; \
	  echo "Example: make test TEST_DIR=tests_targeted TEST_THEORY=Max_Test"; \
	  exit 1; \
	fi
	@$(ISABELLE_BUILD_SILENT) 
	@$(MAKE) run   TEST_THEORY="$(TEST_THEORY)" RUST_OUT="$(TEST_DIR)/Rust_Out"

# Run the targeted test suite case
# Each one is executed via `make test`, and we count pass/fail.
#
# Usage:
#   make targeted
targeted:
	@TD="tests_targeted"; \
	FILES=$$(ls "$$TD"/*_Test.thy 2>/dev/null || true); \
	if [ -z "$$FILES" ]; then \
	  echo "No .thy files found under $$TD"; \
	  exit 0; \
	fi; \
	SUCCESS=0; FAIL=0; TOTAL=0; \
	for f in $$FILES; do \
	  T=$${f##*/}; T=$${T%.thy}; \
	  TOTAL=$$((TOTAL+1)); \
	  echo ">>> [$$TOTAL] Testing $$T"; \
	  if $(MAKE) -s test TEST_DIR="$$TD" TEST_THEORY="$$T"; then \
	    SUCCESS=$$((SUCCESS+1)); \
	  else \
	    FAIL=$$((FAIL+1)); \
	  fi; \
	done; \
	echo "========================================"; \
	echo "Targeted tests summary:"; \
	echo "  Passed:  $$SUCCESS"; \
	echo "  Failed:  $$FAIL"; \
	echo "  Total:   $$TOTAL"


clean:
	@echo "Cleaning temporary files..."
	find . -name "*\.thy~" -exec rm {} \;
	find . -name "*\.cmi"  -exec rm {} \;
	find . -name "*\.cmo"  -exec rm {} \;
	@echo "Removing Rust_Out directories..."
	rm -rf tests_targeted/Rust_Out

help:
	@echo "Available targets:"
	@echo "  open"
	@echo "      Open $(DEFAULT_FILE) in Isabelle/jEdit."
	@echo "  build TEST_DIR=<dir> TEST_THEORY=<thy-name>"
	@echo "      Generate ROOT from ROOT.template and run isabelle build."
	@echo "      Example: make build TEST_DIR=tests_targeted TEST_THEORY=Max_Test"
	@echo "  code"
	@echo "      Run isabelle build using the existing ROOT file."
	@echo "  run TEST_THEORY=<thy-name> RUST_OUT=<rust-out-root>"
	@echo "      Run all Cargo projects under RUST_OUT/TEST_THEORY/export*/."
	@echo "      Example: make run TEST_THEORY=Max_Test RUST_OUT=tests_targeted/Rust_Out"
	@echo "  test TEST_DIR=<dir> TEST_THEORY=<thy-name>"
	@echo "      Build Isabelle session and then run all exported Cargo projects."
	@echo "      Example: make test TEST_DIR=tests_targeted TEST_THEORY=Max_Test"
	@echo "  targeted"
	@echo "      Run the targeded test suite case"
	@echo "      Example: make targeted"
	@echo "  clean"
	@echo "      Remove temporary and build artefacts."