.PHONY: open build code test clean help

#### Configuration ####

# Default Isabelle theory to open in jEdit
DEFAULT_FILE    := $(CURDIR)/Rust_Setup.thy

# Isabelle session name (matches ROOT.template/session)
SESSION         := Test
ROOT_FILE       := ROOT

# Tools
CARGO           ?= cargo
ISABELLE_BUILD  := isabelle build -v -e -d . $(SESSION)

# Default directories
# TEST_DIR        ?= tests_targeted                  # where .thy tests live
# RUST_OUT   ?= tests_targeted/Rust_Out         # where Rust export/ lives
# User must provide TEST_THEORY, no default


#### Targets ###


# Open the default Isabelle theory in jEdit
open:
	isabelle jedit -d . $(DEFAULT_FILE)

# Generate ROOT from ROOT.template and build the Isabelle session.
# Requires:
#   TEST_DIR       directory containing the .thy file
#   TEST_THEORY    base name of the theory (without .thy)
#
# Usage:
#   make build TEST_DIR=tests_targeted TEST_THEORY=Max_Test
build:
	@if [ -z "$(TEST_DIR)" ] || [ -z "$(TEST_THEORY)" ]; then \
	  echo "Error: missing parameters for 'build'."; \
	  echo "Usage:   make build TEST_DIR=<dir> TEST_THEORY=<thy-name>"; \
	  echo "Example: make build TEST_DIR=tests_targeted TEST_THEORY=Max_Test"; \
	  exit 1; \
	fi
	@echo "Generating $(ROOT_FILE) for theory: $(TEST_DIR)/$(TEST_THEORY).thy"
	@sed \
	  -e 's|@TEST_DIR@|$(TEST_DIR)|g' \
	  -e 's|@TEST_THEORY@|$(TEST_THEORY)|g' \
	  ROOT.template > $(ROOT_FILE)
	@echo "Building Isabelle session '$(SESSION)'..."
	@$(ISABELLE_BUILD)

# Isabelle build using existing ROOT (no template substitution).
code:
	@$(ISABELLE_BUILD)

# Run exported Rust projects for a given theory.
# Assumes cargo projects are under:
#   $(RUST_OUT)/$(TEST_THEORY)/export*/Cargo.toml
#
# Requires:
#   TEST_THEORY    e.g. Max_Test
#   RUST_OUT  e.g. tests_targeted/Rust_Out
#
# Usage:
#   make test TEST_THEORY=Max_Test RUST_OUT=tests_targeted/Rust_Out
test:
	@if [ -z "$(TEST_THEORY)" ] || [ -z "$(RUST_OUT)" ]; then \
	  echo "Error: missing parameters for 'test'."; \
	  echo "Usage:   make test TEST_THEORY=<thy-name> RUST_OUT=<rust-out-root>"; \
	  echo "Example: make test TEST_THEORY=Max_Test RUST_OUT=tests_targeted/Rust_Out"; \
	  exit 1; \
	fi
	@OUT_DIR="$(RUST_OUT)/$(TEST_THEORY)"; \
	if [ ! -d "$$OUT_DIR" ]; then \
	  echo "Output directory not found: $$OUT_DIR"; \
	  echo "Expected: $$OUT_DIR"; \
	  exit 1; \
	fi; \
	MANIFESTS=$$(find "$$OUT_DIR" -maxdepth 2 -type f -name Cargo.toml | sort); \
	if [ -z "$$MANIFESTS" ]; then \
	  echo "No Cargo.toml found under $$OUT_DIR"; \
	  exit 1; \
	fi; \
	for m in $$MANIFESTS; do \
	  echo "=== Running Cargo project: $$m ==="; \
	  RUSTFLAGS="-Awarnings" $(CARGO) run --manifest-path "$$m" || exit 1; \
	  echo ""; \
	done

# Remove editor and compiler artefacts
clean:
	@echo "Cleaning temporary files..."
	find . -name "*\.thy~" -exec rm {} \;
	find . -name "*\.cmi"  -exec rm {} \;
	find . -name "*\.cmo"  -exec rm {} \;

# Show brief usage information
help:
	@echo "Available targets:"
	@echo "  open"
	@echo "      Open $(DEFAULT_FILE) in Isabelle/jEdit."
	@echo "  build TEST_DIR=<dir> TEST_THEORY=<thy-name>"
	@echo "      Generate ROOT from ROOT.template and run isabelle build."
	@echo "      Example: make build TEST_DIR=tests_targeted TEST_THEORY=Max_Test"
	@echo "  code"
	@echo "      Run isabelle build using the existing ROOT file."
	@echo "  test TEST_THEORY=<thy-name> RUST_OUT=<rust-out-root>"
	@echo "      Run all Cargo projects under RUST_OUT/TEST_THEORY/export*/."
	@echo "      Example: make test TEST_THEORY=Max_Test RUST_OUT=tests_targeted/Rust_Out"
	@echo "  clean"
	@echo "      Remove temporary and build artefacts."